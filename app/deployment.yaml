# Karpenter SQS Subscriber Deployment
#
# To enable the do-not-disrupt feature (label and cordon nodes in impaired AZ):
# Uncomment the 'args' section in the container spec below
#
apiVersion: apps/v1
kind: Deployment
metadata:
  name: karpenter-sqs-subscriber
  namespace: default
spec:
  replicas: 2
  selector:
    matchLabels:
      app: karpenter-sqs-subscriber
  template:
    metadata:
      labels:
        app: karpenter-sqs-subscriber
    spec:
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
              - matchExpressions:
                  - key: zonal-autoshift-karpenter
                    operator: In
                    values:
                      - karpenter
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            - labelSelector:
                matchLabels:
                  app: karpenter-sqs-subscriber
              topologyKey: topology.kubernetes.io/zone
      dnsConfig:
        nameservers:
          - 8.8.8.8
      serviceAccountName: karpenter-sqs-subscriber
      automountServiceAccountToken: true
      securityContext:
        runAsNonRoot: true
        runAsUser: 10000
        runAsGroup: 10000
        fsGroup: 10000
      containers:
        - name: karpenter-sqs-subscriber
          image: $AWS_ACCOUNT.dkr.ecr.$AWS_REGION.amazonaws.com/zonalautoshiftkarpenter
          # Uncomment the lines below to enable the do-not-disrupt feature
          # command: ["/sns-subscriber"]
          # args: ["--enable-do-not-disrupt"]
          #
          # To customize Kubernetes client performance (defaults: QPS=100, Burst=200):
          # args: ["--kube-client-qps=50", "--kube-client-burst=100"]
          #
          # To enable both do-not-disrupt and custom client settings:
          # args: ["--enable-do-not-disrupt", "--kube-client-qps=150", "--kube-client-burst=300"]
          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            runAsNonRoot: true
            runAsUser: 10000
            capabilities:
              drop:
                - ALL
              add: []
            seccompProfile:
              type: RuntimeDefault
          volumeMounts:
            - name: log-volume
              mountPath: /var/log
          env:
            - name: AWS_REGION
              value: "$AWS_REGION"
            - name: AWS_ACCOUNT_ID
              value: "$AWS_ACCOUNT"
            - name: CLUSTER_NAME
              value: "$CLUSTER_NAME"
            - name: SQS_QUEUE_URL
              value: "$SQS_QUEUE_URL"
            - name: POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
            - name: POD_NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
          imagePullPolicy: Always
          resources:
            requests:
              cpu: "100m"
              memory: "128Mi"
            limits:
              cpu: "500m"
              memory: "256Mi"
      volumes:
        - name: log-volume
          emptyDir:
            medium: Memory
